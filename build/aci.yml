# In case there's a newer OS version that needs to be picked up
schedules:
- cron: "0 0 * * 3"
  displayName: Weekly Wednesday Build
  branches:
    include:
    - main
  always: true

resources:
  pipelines:
  - pipeline: webappbuild
    project: public
    source: number-sequence
    trigger:
      branches:
        include:
        - main

# Don't build on every push, but let the resource/pipeline trigger build it instead
trigger: none

name: '$(Date:%y).$(DayOfYear).$(Rev:r)'

pool:
  vmImage: ubuntu-22.04

steps:

- download: webappbuild
  artifact: drop
  displayName: Download built webapp

- task: ExtractFiles@1
  inputs:
    archiveFilePatterns: $(Agent.BuildDirectory)/webappbuild/**.zip
    destinationFolder: $(Agent.BuildDirectory)/ns-extract/

- task: CopyFiles@1
  inputs:
    sourceFolder: $(Build.SourcesDirectory)/build/
    contents: aci.Dockerfile
    targetFolder: $(Agent.BuildDirectory)/ns-extract/

- task: Docker@2
  displayName: Login to ACR
  inputs:
    command: login
    containerRegistry: c63008fe-73cc-485c-a90f-7de29f409078

- task: Docker@2
  displayName: Build and Push
  inputs:
    command: buildAndPush
    Dockerfile: $(Agent.BuildDirectory)/ns-extract/aci.Dockerfile
    repository: latex
    tags: latest
