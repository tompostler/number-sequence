variables:
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages

schedules:
- cron: 0 0 * * Wed
  displayName: Weekly build (patching)
  branches:
    include:
    - main
  always: true

trigger:
- main

name: '$(Date:%y).$(DayOfYear).$(Rev:r)'

stages:


- stage: Build
  jobs:
  - template: jobs/build.yml


- stage: Deploy_PreReqs
  dependsOn: []
  displayName: Deploy PreReqs
  pool:
    vmImage: windows-latest
  jobs:

  - job: Deploy_AppInsights
    displayName: Deploy AppInsights
    steps:
    - checkout: self
      fetchDepth: 1
      fetchTags: false
    - task: AzureResourceManagerTemplateDeployment@3
      displayName: ARM Template Deployment
      inputs:
        azureResourceManagerConnection: f54f1d6c-d346-41c4-a385-f3b9a579059f
        subscriptionId: 78560c44-50bb-4840-9d59-84578a99032e
        resourceGroupName: tcp-wtf-hosting
        location: Central US
        csmFile: $(Build.SourcesDirectory)/deployment/templates/AppInsights.json
        csmParametersFile: $(Build.SourcesDirectory)/deployment/parameters/Empty.json
